"use strict";function t(t,e,s,r){return new(s||(s=Promise))((function(n,i){function o(t){try{h(r.next(t))}catch(t){i(t)}}function a(t){try{h(r.throw(t))}catch(t){i(t)}}function h(t){var e;t.done?n(t.value):(e=t.value,e instanceof s?e:new s((function(t){t(e)}))).then(o,a)}h((r=r.apply(t,e||[])).next())}))}function e(t){return t&&t.__esModule&&Object.prototype.hasOwnProperty.call(t,"default")?t.default:t}"function"==typeof SuppressedError&&SuppressedError;var s,r={exports:{}};var n,i=(s||(s=1,r.exports=function(t){var e=["0","1","2","3","4","5","6","7","8","9","a","b","c","d","e","f"];function s(t,e){var s=t[0],r=t[1],n=t[2],i=t[3];r=((r+=((n=((n+=((i=((i+=((s=((s+=(r&n|~r&i)+e[0]-680876936|0)<<7|s>>>25)+r|0)&r|~s&n)+e[1]-389564586|0)<<12|i>>>20)+s|0)&s|~i&r)+e[2]+606105819|0)<<17|n>>>15)+i|0)&i|~n&s)+e[3]-1044525330|0)<<22|r>>>10)+n|0,r=((r+=((n=((n+=((i=((i+=((s=((s+=(r&n|~r&i)+e[4]-176418897|0)<<7|s>>>25)+r|0)&r|~s&n)+e[5]+1200080426|0)<<12|i>>>20)+s|0)&s|~i&r)+e[6]-1473231341|0)<<17|n>>>15)+i|0)&i|~n&s)+e[7]-45705983|0)<<22|r>>>10)+n|0,r=((r+=((n=((n+=((i=((i+=((s=((s+=(r&n|~r&i)+e[8]+1770035416|0)<<7|s>>>25)+r|0)&r|~s&n)+e[9]-1958414417|0)<<12|i>>>20)+s|0)&s|~i&r)+e[10]-42063|0)<<17|n>>>15)+i|0)&i|~n&s)+e[11]-1990404162|0)<<22|r>>>10)+n|0,r=((r+=((n=((n+=((i=((i+=((s=((s+=(r&n|~r&i)+e[12]+1804603682|0)<<7|s>>>25)+r|0)&r|~s&n)+e[13]-40341101|0)<<12|i>>>20)+s|0)&s|~i&r)+e[14]-1502002290|0)<<17|n>>>15)+i|0)&i|~n&s)+e[15]+1236535329|0)<<22|r>>>10)+n|0,r=((r+=((n=((n+=((i=((i+=((s=((s+=(r&i|n&~i)+e[1]-165796510|0)<<5|s>>>27)+r|0)&n|r&~n)+e[6]-1069501632|0)<<9|i>>>23)+s|0)&r|s&~r)+e[11]+643717713|0)<<14|n>>>18)+i|0)&s|i&~s)+e[0]-373897302|0)<<20|r>>>12)+n|0,r=((r+=((n=((n+=((i=((i+=((s=((s+=(r&i|n&~i)+e[5]-701558691|0)<<5|s>>>27)+r|0)&n|r&~n)+e[10]+38016083|0)<<9|i>>>23)+s|0)&r|s&~r)+e[15]-660478335|0)<<14|n>>>18)+i|0)&s|i&~s)+e[4]-405537848|0)<<20|r>>>12)+n|0,r=((r+=((n=((n+=((i=((i+=((s=((s+=(r&i|n&~i)+e[9]+568446438|0)<<5|s>>>27)+r|0)&n|r&~n)+e[14]-1019803690|0)<<9|i>>>23)+s|0)&r|s&~r)+e[3]-187363961|0)<<14|n>>>18)+i|0)&s|i&~s)+e[8]+1163531501|0)<<20|r>>>12)+n|0,r=((r+=((n=((n+=((i=((i+=((s=((s+=(r&i|n&~i)+e[13]-1444681467|0)<<5|s>>>27)+r|0)&n|r&~n)+e[2]-51403784|0)<<9|i>>>23)+s|0)&r|s&~r)+e[7]+1735328473|0)<<14|n>>>18)+i|0)&s|i&~s)+e[12]-1926607734|0)<<20|r>>>12)+n|0,r=((r+=((n=((n+=((i=((i+=((s=((s+=(r^n^i)+e[5]-378558|0)<<4|s>>>28)+r|0)^r^n)+e[8]-2022574463|0)<<11|i>>>21)+s|0)^s^r)+e[11]+1839030562|0)<<16|n>>>16)+i|0)^i^s)+e[14]-35309556|0)<<23|r>>>9)+n|0,r=((r+=((n=((n+=((i=((i+=((s=((s+=(r^n^i)+e[1]-1530992060|0)<<4|s>>>28)+r|0)^r^n)+e[4]+1272893353|0)<<11|i>>>21)+s|0)^s^r)+e[7]-155497632|0)<<16|n>>>16)+i|0)^i^s)+e[10]-1094730640|0)<<23|r>>>9)+n|0,r=((r+=((n=((n+=((i=((i+=((s=((s+=(r^n^i)+e[13]+681279174|0)<<4|s>>>28)+r|0)^r^n)+e[0]-358537222|0)<<11|i>>>21)+s|0)^s^r)+e[3]-722521979|0)<<16|n>>>16)+i|0)^i^s)+e[6]+76029189|0)<<23|r>>>9)+n|0,r=((r+=((n=((n+=((i=((i+=((s=((s+=(r^n^i)+e[9]-640364487|0)<<4|s>>>28)+r|0)^r^n)+e[12]-421815835|0)<<11|i>>>21)+s|0)^s^r)+e[15]+530742520|0)<<16|n>>>16)+i|0)^i^s)+e[2]-995338651|0)<<23|r>>>9)+n|0,r=((r+=((i=((i+=(r^((s=((s+=(n^(r|~i))+e[0]-198630844|0)<<6|s>>>26)+r|0)|~n))+e[7]+1126891415|0)<<10|i>>>22)+s|0)^((n=((n+=(s^(i|~r))+e[14]-1416354905|0)<<15|n>>>17)+i|0)|~s))+e[5]-57434055|0)<<21|r>>>11)+n|0,r=((r+=((i=((i+=(r^((s=((s+=(n^(r|~i))+e[12]+1700485571|0)<<6|s>>>26)+r|0)|~n))+e[3]-1894986606|0)<<10|i>>>22)+s|0)^((n=((n+=(s^(i|~r))+e[10]-1051523|0)<<15|n>>>17)+i|0)|~s))+e[1]-2054922799|0)<<21|r>>>11)+n|0,r=((r+=((i=((i+=(r^((s=((s+=(n^(r|~i))+e[8]+1873313359|0)<<6|s>>>26)+r|0)|~n))+e[15]-30611744|0)<<10|i>>>22)+s|0)^((n=((n+=(s^(i|~r))+e[6]-1560198380|0)<<15|n>>>17)+i|0)|~s))+e[13]+1309151649|0)<<21|r>>>11)+n|0,r=((r+=((i=((i+=(r^((s=((s+=(n^(r|~i))+e[4]-145523070|0)<<6|s>>>26)+r|0)|~n))+e[11]-1120210379|0)<<10|i>>>22)+s|0)^((n=((n+=(s^(i|~r))+e[2]+718787259|0)<<15|n>>>17)+i|0)|~s))+e[9]-343485551|0)<<21|r>>>11)+n|0,t[0]=s+t[0]|0,t[1]=r+t[1]|0,t[2]=n+t[2]|0,t[3]=i+t[3]|0}function r(t){var e,s=[];for(e=0;e<64;e+=4)s[e>>2]=t.charCodeAt(e)+(t.charCodeAt(e+1)<<8)+(t.charCodeAt(e+2)<<16)+(t.charCodeAt(e+3)<<24);return s}function n(t){var e,s=[];for(e=0;e<64;e+=4)s[e>>2]=t[e]+(t[e+1]<<8)+(t[e+2]<<16)+(t[e+3]<<24);return s}function i(t){var e,n,i,o,a,h,u=t.length,c=[1732584193,-271733879,-1732584194,271733878];for(e=64;e<=u;e+=64)s(c,r(t.substring(e-64,e)));for(n=(t=t.substring(e-64)).length,i=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],e=0;e<n;e+=1)i[e>>2]|=t.charCodeAt(e)<<(e%4<<3);if(i[e>>2]|=128<<(e%4<<3),e>55)for(s(c,i),e=0;e<16;e+=1)i[e]=0;return o=(o=8*u).toString(16).match(/(.*?)(.{0,8})$/),a=parseInt(o[2],16),h=parseInt(o[1],16)||0,i[14]=a,i[15]=h,s(c,i),c}function o(t){var e,r,i,o,a,h,u=t.length,c=[1732584193,-271733879,-1732584194,271733878];for(e=64;e<=u;e+=64)s(c,n(t.subarray(e-64,e)));for(r=(t=e-64<u?t.subarray(e-64):new Uint8Array(0)).length,i=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],e=0;e<r;e+=1)i[e>>2]|=t[e]<<(e%4<<3);if(i[e>>2]|=128<<(e%4<<3),e>55)for(s(c,i),e=0;e<16;e+=1)i[e]=0;return o=(o=8*u).toString(16).match(/(.*?)(.{0,8})$/),a=parseInt(o[2],16),h=parseInt(o[1],16)||0,i[14]=a,i[15]=h,s(c,i),c}function a(t){var s,r="";for(s=0;s<4;s+=1)r+=e[t>>8*s+4&15]+e[t>>8*s&15];return r}function h(t){var e;for(e=0;e<t.length;e+=1)t[e]=a(t[e]);return t.join("")}function u(t){return/[\u0080-\uFFFF]/.test(t)&&(t=unescape(encodeURIComponent(t))),t}function c(t,e){var s,r=t.length,n=new ArrayBuffer(r),i=new Uint8Array(n);for(s=0;s<r;s+=1)i[s]=t.charCodeAt(s);return e?i:n}function f(t){return String.fromCharCode.apply(null,new Uint8Array(t))}function l(t,e,s){var r=new Uint8Array(t.byteLength+e.byteLength);return r.set(new Uint8Array(t)),r.set(new Uint8Array(e),t.byteLength),r}function d(t){var e,s=[],r=t.length;for(e=0;e<r-1;e+=2)s.push(parseInt(t.substr(e,2),16));return String.fromCharCode.apply(String,s)}function p(){this.reset()}return h(i("hello")),"undefined"==typeof ArrayBuffer||ArrayBuffer.prototype.slice||function(){function e(t,e){return(t=0|t||0)<0?Math.max(t+e,0):Math.min(t,e)}ArrayBuffer.prototype.slice=function(s,r){var n,i,o,a,h=this.byteLength,u=e(s,h),c=h;return r!==t&&(c=e(r,h)),u>c?new ArrayBuffer(0):(n=c-u,i=new ArrayBuffer(n),o=new Uint8Array(i),a=new Uint8Array(this,u,n),o.set(a),i)}}(),p.prototype.append=function(t){return this.appendBinary(u(t)),this},p.prototype.appendBinary=function(t){this._buff+=t,this._length+=t.length;var e,n=this._buff.length;for(e=64;e<=n;e+=64)s(this._hash,r(this._buff.substring(e-64,e)));return this._buff=this._buff.substring(e-64),this},p.prototype.end=function(t){var e,s,r=this._buff,n=r.length,i=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0];for(e=0;e<n;e+=1)i[e>>2]|=r.charCodeAt(e)<<(e%4<<3);return this._finish(i,n),s=h(this._hash),t&&(s=d(s)),this.reset(),s},p.prototype.reset=function(){return this._buff="",this._length=0,this._hash=[1732584193,-271733879,-1732584194,271733878],this},p.prototype.getState=function(){return{buff:this._buff,length:this._length,hash:this._hash.slice()}},p.prototype.setState=function(t){return this._buff=t.buff,this._length=t.length,this._hash=t.hash,this},p.prototype.destroy=function(){delete this._hash,delete this._buff,delete this._length},p.prototype._finish=function(t,e){var r,n,i,o=e;if(t[o>>2]|=128<<(o%4<<3),o>55)for(s(this._hash,t),o=0;o<16;o+=1)t[o]=0;r=(r=8*this._length).toString(16).match(/(.*?)(.{0,8})$/),n=parseInt(r[2],16),i=parseInt(r[1],16)||0,t[14]=n,t[15]=i,s(this._hash,t)},p.hash=function(t,e){return p.hashBinary(u(t),e)},p.hashBinary=function(t,e){var s=h(i(t));return e?d(s):s},p.ArrayBuffer=function(){this.reset()},p.ArrayBuffer.prototype.append=function(t){var e,r=l(this._buff.buffer,t),i=r.length;for(this._length+=t.byteLength,e=64;e<=i;e+=64)s(this._hash,n(r.subarray(e-64,e)));return this._buff=e-64<i?new Uint8Array(r.buffer.slice(e-64)):new Uint8Array(0),this},p.ArrayBuffer.prototype.end=function(t){var e,s,r=this._buff,n=r.length,i=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0];for(e=0;e<n;e+=1)i[e>>2]|=r[e]<<(e%4<<3);return this._finish(i,n),s=h(this._hash),t&&(s=d(s)),this.reset(),s},p.ArrayBuffer.prototype.reset=function(){return this._buff=new Uint8Array(0),this._length=0,this._hash=[1732584193,-271733879,-1732584194,271733878],this},p.ArrayBuffer.prototype.getState=function(){var t=p.prototype.getState.call(this);return t.buff=f(t.buff),t},p.ArrayBuffer.prototype.setState=function(t){return t.buff=c(t.buff,!0),p.prototype.setState.call(this,t)},p.ArrayBuffer.prototype.destroy=p.prototype.destroy,p.ArrayBuffer.prototype._finish=p.prototype._finish,p.ArrayBuffer.hash=function(t,e){var s=h(o(new Uint8Array(t)));return e?d(s):s},p}()),r.exports),o=e(i);!function(t){t[t.InitializeStatus=0]="InitializeStatus",t[t.PendingStatus=1]="PendingStatus",t[t.FulfilledStatus=2]="FulfilledStatus",t[t.RejectStatus=3]="RejectStatus"}(n||(n={}));class a{constructor(t,e,s,r){this.uspType=r,this.chunks=[],this.uploadedSize=0,this.digest="",this.init=t=>{this.f.digest((e=>{console.log(e),this.digest=e,this.f.read(0,200,(s=>{const r=this.getNew();r.set("size",this.f.size().toString()),r.set("digest",e),r.set("chunk_size",this.chunksize.toString()),r.set("ts",Date.now().toString()),r.set("ext",this.ctx.ext),this.r.initRequest(this.ctx,r,s,t,this.fail)}),(t=>{console.log(t)}))}),(t=>{console.log(t)}))},this.uploadChunk=(t,e,s,r,n)=>{const i=this,a=this.getNew();a.set("upload_id",t),a.set("index",s.toString()),a.set("digest",o.ArrayBuffer.hash(r)),this.r.chunkRequest(this.ctx,a,r,(t=>{console.log(t),i.chunks.push({index:s,etag:t.etag}),s<i.totalChunks-1?i.uploadedSize+=i.chunksize:i.uploadedSize+=i.totalSize-i.chunksize*(i.totalChunks-1),i.progress({uploadedSize:i.uploadedSize,totalSize:i.totalSize}),n()}),this.fail)},this.ctx=t,this.f=e,this.r=s,this.totalSize=this.f.size(),this.chunksize=this.ctx.chunkSize||2097152,this.totalChunks=Math.ceil(this.totalSize/this.chunksize),this.maxConcurrency=Math.min(this.totalChunks,this.ctx.maxConcurrency||5),this.tasks=Array.from({length:this.totalChunks},((t,e)=>e))}getNew(){return new this.uspType}upload(t){const e=this;for(let t=0;t<this.chunks.length;t++){this.chunks[t].index<this.totalChunks-1?this.uploadedSize+=this.chunksize:this.uploadedSize+=this.totalSize-this.chunksize*(this.totalChunks-1),this.progress({uploadedSize:this.uploadedSize,totalSize:this.totalSize})}Promise.all(Array.from({length:this.maxConcurrency},((s,r)=>new Promise((s=>{const n=()=>{const i=this.tasks.shift();if(void 0===i)return void s(r);const o=i*this.chunksize,a=o+this.chunksize>=this.totalSize?this.totalSize:o+this.chunksize;e.f.read(o,a-o,(s=>{e.uploadChunk(t.upload_id,r,i,s,n)}),(t=>{console.log(t)}))};n()}))))).then((e=>{console.log(e),this.merge(t.upload_id)})).catch((t=>console.log(t)))}success(t){console.log("success",t),this.complete(t)}fail(t){console.log(t)}progress(t){console.log("progress",t)}complete(t){console.log(t)}merge(t){const e=this.getNew();e.set("upload_id",t),e.set("digest",this.digest);const s=JSON.stringify(this.chunks),r=this;this.r.mergeRequest(this.ctx,e,s,(t=>{r.success(t)}),this.fail)}on(t,e){switch(t){case"progress":this.progress=e;break;case"retry":break;case"success":this.success=e;break;case"fail":this.fail=e;break;case"complete":this.complete=e}}run(){this.init((t=>{switch(t.status){case 0:this.upload(t);case 1:this.chunks=t.chunks,this.upload(t);break;case 2:this.success(t)}console.log(t.upload_id)}))}}class h{constructor(){this.data={}}set(t,e){this.data[t]=[e]}append(t,e){t in this.data?this.data[t].push(e):this.data[t]=[e]}delete(t){t in this.data&&delete this.data[t]}toString(){const t=new Array;for(const e in this.data)for(const s of this.data[e])t.push(`${e}=${s}`);return t.join("&")}}class u{constructor(t,e,s){this.fsm=t,this.filePath=e,this._size=s}size(){return this._size}read(t,e,s,r){const{filePath:n,fsm:i}=this;i.readFile({filePath:n,position:t,length:e,success(t){s(t.data)},fail(t){r(Error(t.errMsg))}})}_digest(t,e){const{filePath:s,_size:r,fsm:n}=this,i=2062336,a=Math.ceil(r/i),h=new o.ArrayBuffer,u=o=>{if(console.log(i,a,o),o===a){const e=h.end();return h.destroy(),void t(e)}const c=o*i,f=Math.min(r-c,i);n.readFile({filePath:s,position:c,length:f,success(t){console.log(t.data),h.append(t.data),u(++o)},fail(t){e(Error(t.errMsg))}})};u(0)}digest(t,e){this._digest(t,e)}}class c{initRequest(t,e,s,r,n){const{touchUrl:i,headers:o}=t;wx.request({url:i+"?"+e.toString(),data:s,dataType:"json",method:"POST",header:null!=o?o:{"content-type":"application/octet-stream"},success(t){console.log(t.data);const{data:e}=t.data;r(e)},fail(t){n(Error(t.errMsg))}})}chunkRequest(t,e,s,r,n){const{uploadUrl:i,headers:o}=t;wx.request({url:i+"?"+e.toString(),data:s,dataType:"json",method:"POST",header:null!=o?o:{"content-type":"application/octet-stream"},success(t){console.log(t.data);const{data:e}=t.data;r(e)},fail(t){n(Error(t.errMsg))}})}mergeRequest(t,e,s,r,n){const{mergeUrl:i,headers:o}=t;wx.request({url:i+"?"+e.toString(),data:s,dataType:"json",method:"POST",header:null!=o?o:{"content-type":"application/octet-stream"},success(t){console.log(t.data);const{data:e}=t.data;r(e)},fail(t){n(Error(t.errMsg))}})}}const f=wx.getFileSystemManager();module.exports=(e,s)=>t(void 0,void 0,void 0,(function*(){return(t=>new Promise((e=>{f.getFileInfo({filePath:t,success(t){e(t.size)},fail(t){throw Error(t.errMsg)}})})))(s).then((t=>new a(e,new u(f,s,t),new c,h)))}));
